<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>JavaScript and Firebase refresher</title>
</head>

<body>

    <h1 id="welcomeMessage">You haven't connected the JavaScript yet</h1>

    <p>Your tasks: 
    <h2>JavaScript</h2>
    <ul>
        <li>Connect the JavaScript file - this page will tell you when it is done</li>
        <li>Add a button - Make it change the heading "You pressed the button!" </li>
        <button id="myButton">Click me!</button>
        <p id="demo">Button not clicked.</p>
        <li>Add a text input</li>
        <li>The button puts the text in the headings</li>
        <li>Get rid of the alert - the button updates the heading of this page</li>
    </ul>
    <h4>Firebase basics</h4>

    <ul>
        <li>Create a new Firebase or re-use yours from last year</li>
        <li>Remember how to connect up the 'authorised domains'</li>
        <li>Add a button - Make it save the text to Firebase </li>
        <input type="text" id="dataInput" placeholder="Enter data">
        <button onclick="fb_writeUserData" id="submitButton">Submit</button>
        <li>Add another button - Make it read the message from Firebase and write it to the heading of this page</li>
    </ul>
    <h4>Firebase logins</h4>
    <ul>
        <li>Use Google Authentication</li>
        <li>Change what the first button does. Now it saves the text and the user who entered it</li>
        <li>Change what the second button does. Now it displays all the messages and who added them</li>
    </ul>
    <h4>Extension</h4>
    <ul>
        <li>Firebase now stores a list of messages saved by each user</li>
        <li>There is a button that only displays your messages</li>
        <li>You can filter to only display messages from a specific user</li>
    </ul>
    <p>You learned all this last year. You just need to remember how!<br>
        You can Google it, ask a friend, copy from last year's work, even look at <a href="https://sites.google.com/hvhs.school.nz/technology/COMP/12COMP/12-databases/br-firebase-skills">last year's notes</a>, works for you.<br>
        By the end of the week you will have Firebase going.</p>

        <img src="ugh.png" alt="godddssss" width="500" height="500">


    <!-- 2. Link the JavaScript file -->
        <script src="script.js"></script>
        
    
    <!--3. add in firebase-->
        <h1>Write Data to Firebase</h1>
        
    <!-- Firebase SDK initialization scripts -->
    <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js"></script>


 <div class="w3-card-4 auth-container">
        <header class="w3-container w3-blue">
            <h2>Portal Sign In</h2>
        </header>
        <div class="w3-container w3-padding-16">
            <button id="signInButton" class="w3-button w3-blue w3-block w3-large">
                Sign in with Google
            </button>
            <div id="auth-error" class="w3-panel w3-red" style="display:none; margin-top:16px;"></div>
        </div>
    </div>
    
     <script type="module">
        import { 
            fb_initialise, 
            fb_signInWithGoogle, 
            fb_onAuthStateChanged, 
            fb_checkUserExists,
            fb_checkAdminStatus
        } from './fb_io.js';
        
        async function initAuth() {
            try {
                await fb_initialise();
                
                // Check if user is already signed in
                fb_onAuthStateChanged(async (user) => {
                    if (user) {
                        try {
                            const userExists = await fb_checkUserExists(user.uid);
                            if (userExists) {
                                // Check admin status and store in session
                                const isAdmin = await fb_checkAdminStatus(user.uid);
                                sessionStorage.setItem('isAdmin', isAdmin ? 'y' : 'n');
                                sessionStorage.setItem('userEmail', user.email);
                                
                                window.location.href = 'startscreen.html';
                            } else {
                                window.location.href = 'register.html';
                            }
                        } catch (error) {
                            console.error("Error checking user data:", error);
                            document.getElementById('auth-error').textContent = 
                                `Authentication error: ${error.message}`;
                            document.getElementById('auth-error').style.display = 'block';
                        }
                    }
                });
                
                document.getElementById('signInButton').addEventListener('click', async () => {
                    try {
                        const user = await fb_signInWithGoogle();
                        if (user) {
                            const userExists = await fb_checkUserExists(user.uid);
                            if (userExists) {
                                // Check admin status and store in session
                                const isAdmin = await fb_checkAdminStatus(user.uid);
                                sessionStorage.setItem('isAdmin', isAdmin ? 'y' : 'n');
                                sessionStorage.setItem('userEmail', user.email);
                                
                                window.location.href = 'startscreen.html';
                            } else {
                                window.location.href = 'register.html';
                            }
                        }
                    } catch (error) {
                        document.getElementById('auth-error').textContent = 
                            `Sign-in failed: ${error.message}`;
                        document.getElementById('auth-error').style.display = 'block';
                    }
                });
                
            } catch (error) {
                document.getElementById('auth-error').textContent = 
                    `Initialization error: ${error.message}`;
                document.getElementById('auth-error').style.display = 'block';
            }
        }
        
        initAuth();
</script>
</body>

</html>